{"version":3,"sources":["webpack:///./modules/aerservBidAdapter.js"],"names":["utils","BIDDER_CODE","AerServAdapter","ENVIRONMENTS","local","dev","stage","prod","BANNER_PATH","VIDEO_PATH","REQUIRED_PARAMS","_isResponseValid","bidRequest","response","mediaType","vastUrl","adm","cpm","_createBid","bid","createBid","bidderCode","width","w","height","h","ad","addBidResponse","placementCode","NO_BID","_getFirstSize","sizes","sizeObj","isArray","length","_buildQueryParameters","requestParams","Object","keys","params","filter","param","forEach","videoDimensions","video","parseQueryStringParameters","_handleResponse","logError","JSON","parse","e","_callBids","bidRequests","currentUrl","window","parent","document","referrer","location","href","encodeURIComponent","bids","hasValidBidRequest","env","requestPath","pageParameters","url","parameterStr","logMessage","withCredentials","callBids","registerBidAdapter","supportedMediaTypes","module","exports"],"mappings":"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","file":"aerservBidAdapter.js","sourcesContent":["import bidfactory from 'src/bidfactory';\nimport bidmanager from 'src/bidmanager';\nimport * as utils from 'src/utils';\nimport {ajax} from 'src/ajax';\nimport {STATUS} from 'src/constants';\nimport adaptermanager from 'src/adaptermanager';\n\nconst BIDDER_CODE = 'aerserv';\n\nconst AerServAdapter = function AerServAdapter() {\n  const ENVIRONMENTS = {\n    local: '127.0.0.1:8080',\n    dev: 'dev-ads.aerserv.com',\n    stage: 'staging-ads.aerserv.com',\n    prod: 'ads.aerserv.com'\n  };\n\n  const BANNER_PATH = '/as/json/pbjs/v1?';\n  const VIDEO_PATH = '/as/json/pbjsvast/v1?';\n  const REQUIRED_PARAMS = ['plc'];\n\n  function _isResponseValid(bidRequest, response) {\n    return ((bidRequest.mediaType === 'video' && response.vastUrl) || (bidRequest.mediaType !== 'video' && response.adm)) &&\n      response.cpm && response.cpm > 0;\n  }\n\n  function _createBid(bidRequest, response) {\n    if (_isResponseValid(bidRequest, response)) {\n      let bid = bidfactory.createBid(1, bidRequest);\n      bid.bidderCode = BIDDER_CODE;\n      bid.cpm = response.cpm;\n      bid.width = response.w;\n      bid.height = response.h;\n      if (bidRequest.mediaType === 'video') {\n        bid.vastUrl = response.vastUrl;\n        bid.mediaType = 'video';\n      } else {\n        bid.ad = response.adm;\n      }\n      bidmanager.addBidResponse(bidRequest.placementCode, bid);\n    } else {\n      bidmanager.addBidResponse(bidRequest.placementCode, bidfactory.createBid(STATUS.NO_BID, bidRequest));\n    }\n  }\n\n  function _getFirstSize(sizes) {\n    let sizeObj = {};\n    if (utils.isArray(sizes) && sizes.length > 0 && utils.isArray(sizes[0]) && sizes[0].length === 2) {\n      sizeObj['vpw'] = sizes[0][0];\n      sizeObj['vph'] = sizes[0][1];\n    }\n    return sizeObj;\n  }\n\n  function _buildQueryParameters(bid, requestParams) {\n    Object.keys(bid.params).filter(param => param !== 'video')\n      .forEach(param => requestParams[param] = bid.params[param]);\n\n    if (bid.mediaType === 'video') {\n      let videoDimensions = _getFirstSize(bid.sizes);\n      Object.keys(videoDimensions).forEach(param => requestParams[param] = videoDimensions[param]);\n      Object.keys(bid.params.video || {}).forEach(param => requestParams[param] = bid.params.video[param]);\n    }\n\n    return utils.parseQueryStringParameters(requestParams);\n  }\n\n  function _handleResponse(bidRequest) {\n    return response => {\n      if (!response && response.length <= 0) {\n        bidmanager.addBidResponse(bidRequest.placementCode, bidfactory.createBid(STATUS.NO_BID, bidRequest));\n        utils.logError('Empty response');\n        return;\n      }\n\n      try {\n        response = JSON.parse(response);\n      } catch (e) {\n        bidmanager.addBidResponse(bidRequest.placementCode, bidfactory.createBid(STATUS.NO_BID, bidRequest));\n        utils.logError('Invalid JSON in response');\n        return;\n      }\n\n      _createBid(bidRequest, response);\n    };\n  }\n\n  function _callBids(bidRequests) {\n    let currentUrl = (window.parent !== window) ? document.referrer : window.location.href;\n    currentUrl = currentUrl && encodeURIComponent(currentUrl);\n\n    let bids = bidRequests.bids || [];\n    bids.forEach(bid => {\n      if (utils.hasValidBidRequest(bid.params, REQUIRED_PARAMS, BIDDER_CODE)) {\n        let env = ENVIRONMENTS[bid.params['env']] || ENVIRONMENTS['prod'];\n        let requestPath = bid.mediaType === 'video' ? VIDEO_PATH : BANNER_PATH;\n        let pageParameters = {url: currentUrl};\n        let parameterStr = _buildQueryParameters(bid, pageParameters);\n\n        let url = `//${env}${requestPath}${parameterStr}`;\n        utils.logMessage('sending request to: ' + url);\n        ajax(url, _handleResponse(bid), null, {withCredentials: true});\n      } else {\n        bidmanager.addBidResponse(bid.placementCode, bidfactory.createBid(STATUS.NO_BID, bid));\n      }\n    });\n  }\n\n  return {\n    callBids: _callBids\n  }\n};\n\nadaptermanager.registerBidAdapter(new AerServAdapter(), BIDDER_CODE, {supportedMediaTypes: ['video']});\n\nmodule.exports = AerServAdapter;\n\n\n\n// WEBPACK FOOTER //\n// ./modules/aerservBidAdapter.js"],"sourceRoot":""}