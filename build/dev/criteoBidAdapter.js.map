{"version":3,"sources":["webpack:///./modules/criteoBidAdapter.js"],"names":["bidfactory","require","bidmanager","adloader","adaptermanager","utils","CriteoAdapter","sProt","window","location","protocol","_publisherTagUrl","_bidderCode","_profileId","_callBids","params","criteo_pubtag","Array","_pushBidRequestEvent","criteoFastBid","_tryGetCriteoFastBid","eval","loadScript","localStorage","getItem","e","Criteo","events","biddingEventFunc","bids","slots","isAudit","networkid","integrationMode","i","length","bid","sizes","parseSizesInput","push","PubTag","DirectBidding","DirectBiddingSlot","placementCode","zoneId","nativeCallback","undefined","transactionId","map","sizeString","xIndex","indexOf","w","parseInt","substring","h","Size","networkId","toLowerCase","audit","biddingEvent","DirectBiddingEvent","DirectBiddingUrlBuilder","_callbackSuccess","_callbackError","parseBidResponse","bidsResponse","JSON","parse","error","isNoBidResponse","jsonbidsResponse","bidResponse","j","impid","impId","splice","bidObject","_buildBidObject","addBidResponse","_invalidBidResponse","createBid","bidderCode","slot","cpm","native","logError","native_slots","adId","callback","nativeResponse","ad","width","height","creative","callBids","registerBidAdapter","module","exports"],"mappings":"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","file":"criteoBidAdapter.js","sourcesContent":["/* eslint-disable */\nvar bidfactory = require('src/bidfactory.js');\nvar bidmanager = require('src/bidmanager.js');\nvar adloader = require('src/adloader');\nvar adaptermanager = require('src/adaptermanager');\nvar utils = require('src/utils');\n\nvar CriteoAdapter = function CriteoAdapter() {\n  var sProt = (window.location.protocol === 'http:') ? 'http:' : 'https:';\n  var _publisherTagUrl = sProt + '//static.criteo.net/js/ld/publishertag.prebid.js';\n  var _bidderCode = 'criteo';\n  var _profileId = 125;\n\n  function _callBids(params) {\n    if (!window.criteo_pubtag || window.criteo_pubtag instanceof Array) {\n      // publisherTag not loaded yet\n\n      _pushBidRequestEvent(params);\n      var criteoFastBid = _tryGetCriteoFastBid();\n      if (criteoFastBid) {\n        eval(criteoFastBid);\n      } else {\n        adloader.loadScript(\n          _publisherTagUrl,\n          function () { },\n          false\n        );\n      }\n    } else {\n      // publisherTag already loaded\n      _pushBidRequestEvent(params);\n    }\n  }\n\n  function _tryGetCriteoFastBid() {\n    try {\n      return localStorage.getItem('criteo_fast_bid');\n    } catch (e) {\n      return null;\n    }\n  }\n\n  // send bid request to criteo direct bidder handler\n  function _pushBidRequestEvent(params) {\n    // if we want to be fully asynchronous, we must first check window.criteo_pubtag in case publishertag.js is not loaded yet.\n    window.Criteo = window.Criteo || {};\n    window.Criteo.events = window.Criteo.events || [];\n\n    // generate the bidding event\n    var biddingEventFunc = function () {\n      var bids = params.bids || [];\n      var slots = [];\n      var isAudit = false;\n      var networkid;\n      var integrationMode;\n\n      // build slots before sending one multi-slots bid request\n      for (var i = 0; i < bids.length; i++) {\n        var bid = bids[i];\n        var sizes = utils.parseSizesInput(bid.sizes);\n        slots.push(\n          new Criteo.PubTag.DirectBidding.DirectBiddingSlot(\n            bid.placementCode,\n            bid.params.zoneId,\n            bid.params.nativeCallback ? bid.params.nativeCallback : undefined,\n            bid.transactionId,\n            sizes.map((sizeString) => {\n              var xIndex = sizeString.indexOf('x');\n              var w = parseInt(sizeString.substring(0, xIndex));\n              var h = parseInt(sizeString.substring(xIndex + 1, sizeString.length))\n              return new Criteo.PubTag.DirectBidding.Size(w, h);\n            }\n            )\n          )\n        );\n\n        networkid = bid.params.networkId || networkid;\n        if (bid.params.integrationMode !== undefined) {\n          integrationMode = bid.params.integrationMode.toLowerCase() == 'amp' ? 1 : 0;\n        }\n\n        isAudit |= bid.params.audit !== undefined;\n      }\n\n      var biddingEvent = new Criteo.PubTag.DirectBidding.DirectBiddingEvent(\n        _profileId,\n        new Criteo.PubTag.DirectBidding.DirectBiddingUrlBuilder(isAudit),\n        slots,\n        _callbackSuccess(slots),\n        _callbackError(slots),\n        _callbackError(slots), // timeout handled as error\n        undefined,\n        networkid,\n        integrationMode\n      );\n\n      // process the event as soon as possible\n      window.criteo_pubtag.push(biddingEvent);\n    };\n\n    window.Criteo.events.push(biddingEventFunc);\n  }\n\n  function parseBidResponse(bidsResponse) {\n    try {\n      return JSON.parse(bidsResponse);\n    } catch (error) {\n      return {};\n    }\n  }\n\n  function isNoBidResponse(jsonbidsResponse) {\n    return jsonbidsResponse.slots === undefined;\n  }\n\n  function _callbackSuccess(slots) {\n    return function (bidsResponse) {\n      var jsonbidsResponse = parseBidResponse(bidsResponse);\n\n      if (isNoBidResponse(jsonbidsResponse)) { return _callbackError(slots)(); }\n\n      for (var i = 0; i < slots.length; i++) {\n        var bidResponse = null;\n\n        // look for the matching bid response\n        for (var j = 0; j < jsonbidsResponse.slots.length; j++) {\n          if (jsonbidsResponse.slots[j] && jsonbidsResponse.slots[j].impid === slots[i].impId) {\n            bidResponse = jsonbidsResponse.slots.splice(j, 1)[0];\n            break;\n          }\n        }\n\n        // register the bid response\n        let bidObject = _buildBidObject(bidResponse, slots[i]);\n        bidmanager.addBidResponse(slots[i].impId, bidObject);\n      }\n    };\n  }\n\n  function _callbackError(slots) {\n    return function () {\n      for (var i = 0; i < slots.length; i++) {\n        bidmanager.addBidResponse(slots[i].impId, _invalidBidResponse());\n      }\n    };\n  }\n\n  function _invalidBidResponse() {\n    var bidObject = bidfactory.createBid(2);\n    bidObject.bidderCode = _bidderCode;\n    return bidObject;\n  }\n\n  function _buildBidObject(bidResponse, slot) {\n    let bidObject;\n    if (bidResponse) {\n      // map the common fields\n      bidObject = bidfactory.createBid(1);\n      bidObject.bidderCode = _bidderCode;\n      bidObject.cpm = bidResponse.cpm;\n\n      // in case of native\n      if (slot.nativeCallback && bidResponse.native) {\n        if (typeof slot.nativeCallback !== 'function') {\n          utils.logError('Criteo bid: nativeCallback parameter is not a function');\n        } else {\n          // store the callbacks in a global object\n          window.criteo_pubtag.native_slots = window.criteo_pubtag.native_slots || {};\n          window.criteo_pubtag.native_slots['' + bidObject.adId] = { callback: slot.nativeCallback, nativeResponse: bidResponse.native };\n\n          // this code is executed in an iframe, we need to get a reference to the\n          // publishertag in the main window to retrieve native responses and callbacks.\n          // it doesn't work with safeframes\n          bidObject.ad = `<script type=\\\"text/javascript\\\">\n  let win = window;\n  for (const i=0; i<10; ++i) {\n    win = win.parent;\n    if (win.criteo_pubtag && win.criteo_pubtag.native_slots) {\n      let responseSlot = win.criteo_pubtag.native_slots[\"${bidObject.adId}\"];\n      responseSlot.callback(responseSlot.nativeResponse);\n      break;\n    }\n  }\n</script>`;\n        }\n      } else {\n        // width and height are only relevant with non-native requests.\n        // native requests will always return a 2x2 zone size.\n        bidObject.width = bidResponse.width;\n        bidObject.height = bidResponse.height;\n        bidObject.ad = bidResponse.creative;\n      }\n    } else {\n      bidObject = _invalidBidResponse();\n    }\n    return bidObject;\n  }\n\n  return {\n    callBids: _callBids\n  };\n};\n\nadaptermanager.registerBidAdapter(new CriteoAdapter(), 'criteo');\n\nmodule.exports = CriteoAdapter;\n\n\n// WEBPACK FOOTER //\n// ./modules/criteoBidAdapter.js"],"sourceRoot":""}