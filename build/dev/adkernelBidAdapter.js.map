{"version":3,"sources":["webpack:///./modules/adkernelBidAdapter.js"],"names":["utils","VIDEO_TARGETING","VERSION","spec","code","aliases","supportedMediaTypes","isBidRequestValid","bidRequest","params","host","isNaN","Number","zoneId","buildRequests","bidRequests","auctionId","dispatch","map","buildImp","reduce","acc","curr","index","push","bidderRequestId","requests","Object","keys","forEach","request","buildRtbRequest","method","url","window","location","protocol","data","zone","ad_type","v","r","JSON","stringify","interpretResponse","serverResponse","response","body","seatbid","rtbRequest","parse","rtbImps","imp","rtbBids","bid","a","b","concat","find","id","rtbBid","impid","prBid","requestId","cpm","price","creativeId","crid","currency","ttl","netRevenue","mediaType","width","banner","w","height","h","ad","formatAdMarkup","vastUrl","nurl","video","getUserSyncs","syncOptions","serverResponses","iframeEnabled","length","filter","rsp","ext","adk_usersync","type","sync_url","size","getAdUnitSize","bidId","placementCode","includes","param","getTopWindowLocation","secure","sizes","imps","createSite","hostname","href","split","adm","createTrackPixelHtml"],"mappings":";;;;;;;;;;;;;;;;;;;;;;AAAA;;IAAYA,K;;AACZ;;AACA;;;;AAEA,IAAMC,kBAAkB,CAAC,OAAD,EAAU,aAAV,EAAyB,aAAzB,EAAwC,WAAxC,EACtB,YADsB,EACR,WADQ,EACK,eADL,EACsB,gBADtB,EACwC,UADxC,EAEtB,KAFsB,EAEf,KAFe,EAER,KAFQ,CAAxB;AAGA,IAAMC,UAAU,KAAhB;;AAEA;;;AAGO,IAAMC,sBAAO;;AAElBC,QAAM,UAFY;AAGlBC,WAAS,CAAC,aAAD,CAHS;AAIlBC,uBAAqB,mBAJH;AAKlBC,qBAAmB,2BAASC,UAAT,EAAqB;AACtC,WAAO,YAAYA,UAAZ,IAA0B,OAAOA,WAAWC,MAAX,CAAkBC,IAAzB,KAAkC,WAA5D,IACL,YAAYF,WAAWC,MADlB,IAC4B,CAACE,MAAMC,OAAOJ,WAAWC,MAAX,CAAkBI,MAAzB,CAAN,CADpC;AAED,GARiB;AASlBC,iBAAe,uBAASC,WAAT,EAAsB;AACnC,QAAIC,kBAAJ;AACA,QAAIC,WAAWF,YAAYG,GAAZ,CAAgBC,QAAhB,EACZC,MADY,CACL,UAACC,GAAD,EAAMC,IAAN,EAAYC,KAAZ,EAAsB;AAC5B,UAAIf,aAAaO,YAAYQ,KAAZ,CAAjB;AACA,UAAIV,SAASL,WAAWC,MAAX,CAAkBI,MAA/B;AACA,UAAIH,OAAOF,WAAWC,MAAX,CAAkBC,IAA7B;AACAW,UAAIX,IAAJ,IAAYW,IAAIX,IAAJ,KAAa,EAAzB;AACAW,UAAIX,IAAJ,EAAUG,MAAV,IAAoBQ,IAAIX,IAAJ,EAAUG,MAAV,KAAqB,EAAzC;AACAQ,UAAIX,IAAJ,EAAUG,MAAV,EAAkBW,IAAlB,CAAuBF,IAAvB;AACAN,kBAAYR,WAAWiB,eAAvB;AACA,aAAOJ,GAAP;AACD,KAVY,EAUV,EAVU,CAAf;AAWA,QAAIK,WAAW,EAAf;AACAC,WAAOC,IAAP,CAAYX,QAAZ,EAAsBY,OAAtB,CAA8B,gBAAQ;AACpCF,aAAOC,IAAP,CAAYX,SAASP,IAAT,CAAZ,EAA4BmB,OAA5B,CAAoC,kBAAU;AAC5C,YAAMC,UAAUC,gBAAgBd,SAASP,IAAT,EAAeG,MAAf,CAAhB,EAAwCG,SAAxC,CAAhB;AACAU,iBAASF,IAAT,CAAc;AACZQ,kBAAQ,KADI;AAEZC,eAAQC,OAAOC,QAAP,CAAgBC,QAAxB,UAAqC1B,IAArC,UAFY;AAGZ2B,gBAAM;AACJC,kBAAM1B,OAAOC,MAAP,CADF;AAEJ0B,qBAAS,KAFL;AAGJC,eAAGtC,OAHC;AAIJuC,eAAGC,KAAKC,SAAL,CAAeb,OAAf;AAJC;AAHM,SAAd;AAUD,OAZD;AAaD,KAdD;AAeA,WAAOJ,QAAP;AACD,GAvCiB;AAwClBkB,qBAAmB,2BAASC,cAAT,EAAyBf,OAAzB,EAAkC;AACnD,QAAIgB,WAAWD,eAAeE,IAA9B;AACA,QAAI,CAACD,SAASE,OAAd,EAAuB;AACrB,aAAO,EAAP;AACD;;AAED,QAAIC,aAAaP,KAAKQ,KAAL,CAAWpB,QAAQO,IAAR,CAAaI,CAAxB,CAAjB;AACA,QAAIU,UAAUF,WAAWG,GAAzB;AACA,QAAIC,UAAUP,SAASE,OAAT,CACX9B,GADW,CACP;AAAA,aAAW8B,QAAQM,GAAnB;AAAA,KADO,EAEXlC,MAFW,CAEJ,UAACmC,CAAD,EAAIC,CAAJ;AAAA,aAAUD,EAAEE,MAAF,CAASD,CAAT,CAAV;AAAA,KAFI,EAEmB,EAFnB,CAAd;;AAIA,WAAOH,QAAQnC,GAAR,CAAY,kBAAU;AAC3B,UAAIkC,MAAMD,QAAQO,IAAR,CAAa;AAAA,eAAON,IAAIO,EAAJ,KAAWC,OAAOC,KAAzB;AAAA,OAAb,CAAV;AACA,UAAIC,QAAQ;AACVC,mBAAWH,OAAOC,KADR;AAEVG,aAAKJ,OAAOK,KAFF;AAGVC,oBAAYN,OAAOO,IAHT;AAIVC,kBAAU,KAJA;AAKVC,aAAK,GALK;AAMVC,oBAAY;AANF,OAAZ;AAQA,UAAI,YAAYlB,GAAhB,EAAqB;AACnBU,cAAMS,SAAN;AACAT,cAAMU,KAAN,GAAcpB,IAAIqB,MAAJ,CAAWC,CAAzB;AACAZ,cAAMa,MAAN,GAAevB,IAAIqB,MAAJ,CAAWG,CAA1B;AACAd,cAAMe,EAAN,GAAWC,eAAelB,MAAf,CAAX;AACD;AACD,UAAI,WAAWR,GAAf,EAAoB;AAClBU,cAAMS,SAAN;AACAT,cAAMiB,OAAN,GAAgBnB,OAAOoB,IAAvB;AACAlB,cAAMU,KAAN,GAAcpB,IAAI6B,KAAJ,CAAUP,CAAxB;AACAZ,cAAMa,MAAN,GAAevB,IAAI6B,KAAJ,CAAUL,CAAzB;AACD;AACD,aAAOd,KAAP;AACD,KAvBM,CAAP;AAwBD,GA5EiB;AA6ElBoB,gBAAc,sBAASC,WAAT,EAAsBC,eAAtB,EAAuC;AACnD,QAAI,CAACD,YAAYE,aAAb,IAA8B,CAACD,eAA/B,IAAkDA,gBAAgBE,MAAhB,KAA2B,CAAjF,EAAoF;AAClF,aAAO,EAAP;AACD;AACD,WAAOF,gBAAgBG,MAAhB,CAAuB;AAAA,aAAOC,IAAIzC,IAAJ,IAAYyC,IAAIzC,IAAJ,CAAS0C,GAArB,IAA4BD,IAAIzC,IAAJ,CAAS0C,GAAT,CAAaC,YAAhD;AAAA,KAAvB,EACJxE,GADI,CACA;AAAA,aAAOsE,IAAIzC,IAAJ,CAAS0C,GAAT,CAAaC,YAApB;AAAA,KADA,EAEJtE,MAFI,CAEG,UAACmC,CAAD,EAAIC,CAAJ;AAAA,aAAUD,EAAEE,MAAF,CAASD,CAAT,CAAV;AAAA,KAFH,EAE0B,EAF1B,EAGJtC,GAHI,CAGA,oBAAY;AACf,aAAO;AACLyE,cAAM,QADD;AAEL1D,aAAK2D;AAFA,OAAP;AAID,KARI,CAAP;AASD;AA1FiB,CAAb;;AA6FP,mCAAezF,IAAf;;AAEA;;;AAGA,SAASgB,QAAT,CAAkBmC,GAAlB,EAAuB;AACrB,MAAMuC,OAAOC,cAAcxC,GAAd,CAAb;AACA,MAAMF,MAAM;AACV,UAAME,IAAIyC,KADA;AAEV,aAASzC,IAAI0C;AAFH,GAAZ;;AAKA,MAAI1C,IAAIiB,SAAJ,KAAkB,OAAtB,EAA+B;AAC7BnB,QAAI6B,KAAJ,GAAY,EAACP,GAAGmB,KAAK,CAAL,CAAJ,EAAajB,GAAGiB,KAAK,CAAL,CAAhB,EAAZ;AACA,QAAIvC,IAAI7C,MAAJ,CAAWwE,KAAf,EAAsB;AACpBtD,aAAOC,IAAP,CAAY0B,IAAI7C,MAAJ,CAAWwE,KAAvB,EACGM,MADH,CACU;AAAA,eAAStF,gBAAgBgG,QAAhB,CAAyBC,KAAzB,CAAT;AAAA,OADV,EAEGrE,OAFH,CAEW;AAAA,eAASuB,IAAI6B,KAAJ,CAAUiB,KAAV,IAAmB5C,IAAI7C,MAAJ,CAAWwE,KAAX,CAAiBiB,KAAjB,CAA5B;AAAA,OAFX;AAGD;AACF,GAPD,MAOO;AACL9C,QAAIqB,MAAJ,GAAa,EAACC,GAAGmB,KAAK,CAAL,CAAJ,EAAajB,GAAGiB,KAAK,CAAL,CAAhB,EAAb;AACD;AACD,MAAI7F,MAAMmG,oBAAN,GAA6B/D,QAA7B,KAA0C,QAA9C,EAAwD;AACtDgB,QAAIgD,MAAJ,GAAa,CAAb;AACD;AACD,SAAOhD,GAAP;AACD;;AAED;;;;;AAKA,SAAS0C,aAAT,CAAuBxC,GAAvB,EAA4B;AAC1B,MAAIA,IAAIiB,SAAJ,KAAkB,OAAtB,EAA+B;AAC7B,WAAOjB,IAAI+C,KAAX;AACD;AACD,SAAO/C,IAAI+C,KAAJ,CAAU,CAAV,CAAP;AACD;;AAED;;;;;AAKA,SAAStE,eAAT,CAAyBuE,IAAzB,EAA+BtF,SAA/B,EAA0C;AACxC,SAAO;AACL,UAAMA,SADD;AAEL,WAAOsF,IAFF;AAGL,YAAQC,YAHH;AAIL,UAAM,CAJD;AAKL,cAAU;AACR,YAAM,QADE;AAER,YAAM;AAFE;AALL,GAAP;AAUD;;AAED;;;AAGA,SAASA,UAAT,GAAsB;AACpB,MAAIpE,WAAWnC,MAAMmG,oBAAN,EAAf;AACA,SAAO;AACL,cAAUhE,SAASqE,QADd;AAEL,YAAQrE,SAASsE,IAAT,CAAcC,KAAd,CAAoB,GAApB,EAAyB,CAAzB;AAFH,GAAP;AAID;;AAED;;;;AAIA,SAAS5B,cAAT,CAAwBxB,GAAxB,EAA6B;AAC3B,MAAIqD,MAAMrD,IAAIqD,GAAd;AACA,MAAI,UAAUrD,GAAd,EAAmB;AACjBqD,WAAO3G,MAAM4G,oBAAN,CAA8BtD,IAAI0B,IAAlC,WAAP;AACD;AACD,gGAA0F2B,GAA1F;AACD,C","file":"adkernelBidAdapter.js","sourcesContent":["import * as utils from 'src/utils';\nimport { BANNER, VIDEO } from 'src/mediaTypes';\nimport {registerBidder} from 'src/adapters/bidderFactory';\n\nconst VIDEO_TARGETING = ['mimes', 'minduration', 'maxduration', 'protocols',\n  'startdelay', 'linearity', 'boxingallowed', 'playbackmethod', 'delivery',\n  'pos', 'api', 'ext'];\nconst VERSION = '1.0';\n\n/**\n * Adapter for requesting bids from AdKernel white-label display platform\n */\nexport const spec = {\n\n  code: 'adkernel',\n  aliases: ['headbidding'],\n  supportedMediaTypes: [VIDEO],\n  isBidRequestValid: function(bidRequest) {\n    return 'params' in bidRequest && typeof bidRequest.params.host !== 'undefined' &&\n      'zoneId' in bidRequest.params && !isNaN(Number(bidRequest.params.zoneId));\n  },\n  buildRequests: function(bidRequests) {\n    let auctionId;\n    let dispatch = bidRequests.map(buildImp)\n      .reduce((acc, curr, index) => {\n        let bidRequest = bidRequests[index];\n        let zoneId = bidRequest.params.zoneId;\n        let host = bidRequest.params.host;\n        acc[host] = acc[host] || {};\n        acc[host][zoneId] = acc[host][zoneId] || [];\n        acc[host][zoneId].push(curr);\n        auctionId = bidRequest.bidderRequestId;\n        return acc;\n      }, {});\n    let requests = [];\n    Object.keys(dispatch).forEach(host => {\n      Object.keys(dispatch[host]).forEach(zoneId => {\n        const request = buildRtbRequest(dispatch[host][zoneId], auctionId);\n        requests.push({\n          method: 'GET',\n          url: `${window.location.protocol}//${host}/rtbg`,\n          data: {\n            zone: Number(zoneId),\n            ad_type: 'rtb',\n            v: VERSION,\n            r: JSON.stringify(request)\n          }\n        });\n      });\n    });\n    return requests;\n  },\n  interpretResponse: function(serverResponse, request) {\n    let response = serverResponse.body;\n    if (!response.seatbid) {\n      return [];\n    }\n\n    let rtbRequest = JSON.parse(request.data.r);\n    let rtbImps = rtbRequest.imp;\n    let rtbBids = response.seatbid\n      .map(seatbid => seatbid.bid)\n      .reduce((a, b) => a.concat(b), []);\n\n    return rtbBids.map(rtbBid => {\n      let imp = rtbImps.find(imp => imp.id === rtbBid.impid);\n      let prBid = {\n        requestId: rtbBid.impid,\n        cpm: rtbBid.price,\n        creativeId: rtbBid.crid,\n        currency: 'USD',\n        ttl: 360,\n        netRevenue: true\n      };\n      if ('banner' in imp) {\n        prBid.mediaType = BANNER;\n        prBid.width = imp.banner.w;\n        prBid.height = imp.banner.h;\n        prBid.ad = formatAdMarkup(rtbBid);\n      }\n      if ('video' in imp) {\n        prBid.mediaType = VIDEO;\n        prBid.vastUrl = rtbBid.nurl;\n        prBid.width = imp.video.w;\n        prBid.height = imp.video.h;\n      }\n      return prBid;\n    });\n  },\n  getUserSyncs: function(syncOptions, serverResponses) {\n    if (!syncOptions.iframeEnabled || !serverResponses || serverResponses.length === 0) {\n      return [];\n    }\n    return serverResponses.filter(rsp => rsp.body && rsp.body.ext && rsp.body.ext.adk_usersync)\n      .map(rsp => rsp.body.ext.adk_usersync)\n      .reduce((a, b) => a.concat(b), [])\n      .map(sync_url => {\n        return {\n          type: 'iframe',\n          url: sync_url\n        }\n      });\n  }\n};\n\nregisterBidder(spec);\n\n/**\n *  Builds parameters object for single impression\n */\nfunction buildImp(bid) {\n  const size = getAdUnitSize(bid);\n  const imp = {\n    'id': bid.bidId,\n    'tagid': bid.placementCode\n  };\n\n  if (bid.mediaType === 'video') {\n    imp.video = {w: size[0], h: size[1]};\n    if (bid.params.video) {\n      Object.keys(bid.params.video)\n        .filter(param => VIDEO_TARGETING.includes(param))\n        .forEach(param => imp.video[param] = bid.params.video[param]);\n    }\n  } else {\n    imp.banner = {w: size[0], h: size[1]};\n  }\n  if (utils.getTopWindowLocation().protocol === 'https:') {\n    imp.secure = 1;\n  }\n  return imp;\n}\n\n/**\n * Return ad unit single size\n * @param bid adunit size definition\n * @return {*}\n */\nfunction getAdUnitSize(bid) {\n  if (bid.mediaType === 'video') {\n    return bid.sizes;\n  }\n  return bid.sizes[0];\n}\n\n/**\n * Builds complete rtb request\n * @param imps collection of impressions\n * @param auctionId\n */\nfunction buildRtbRequest(imps, auctionId) {\n  return {\n    'id': auctionId,\n    'imp': imps,\n    'site': createSite(),\n    'at': 1,\n    'device': {\n      'ip': 'caller',\n      'ua': 'caller'\n    }\n  };\n}\n\n/**\n * Creates site description object\n */\nfunction createSite() {\n  var location = utils.getTopWindowLocation();\n  return {\n    'domain': location.hostname,\n    'page': location.href.split('?')[0]\n  };\n}\n\n/**\n *  Format creative with optional nurl call\n *  @param bid rtb Bid object\n */\nfunction formatAdMarkup(bid) {\n  var adm = bid.adm;\n  if ('nurl' in bid) {\n    adm += utils.createTrackPixelHtml(`${bid.nurl}&px=1`);\n  }\n  return `<!DOCTYPE html><html><head><title></title><body style='margin:0px;padding:0px;'>${adm}</body></head>`;\n}\n\n\n\n// WEBPACK FOOTER //\n// ./modules/adkernelBidAdapter.js"],"sourceRoot":""}