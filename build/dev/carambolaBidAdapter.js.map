{"version":3,"sources":["webpack:///./modules/carambolaBidAdapter.js"],"names":["bidfactory","require","bidmanager","utils","ajax","adaptermanager","CarambolaAdapter","BIDDER_CODE","REQUEST_PATH","_addErrorBidResponse","bid","response","errorMsg","bidResponse","createBid","bidderCode","reason","addBidResponse","_getCustomAdUnitCode","placementCode","_addBidResponse","ad","cpm","width","height","currencyCode","cur","token","pvid","pageViewId","_getPageViewId","window","Cbola","HB","_createPageViewId","_pad","number","MIN","MAX","now","Date","getDate","getMonth","getFullYear","getHours","getMinutes","getSeconds","getMilliseconds","Math","floor","random","_buildRequest","bids","params","isArray","_each","tempParams","cbolaMode","wid","pixel","bidFloor","hb_token","generateUUID","sizes","parseSizesInput","bidsCount","length","customParam","customParams","hasOwnProperty","server","cbolaHbApiUrl","_jsonToQueryString","logError","JSON","parse","e","method","_callBids","isIfr","currentURL","parent","document","referrer","location","href","encodeURIComponent","self","top","pageUrl","did","pid","res","_getScreenSize","screen","ifr","viewPortDim","_getViewportDimensions","colorDepth","tWin","tDoc","docEl","documentElement","body","innerWidth","clientWidth","innerHeight","clientHeight","json","Object","keys","map","key","join","callBids","registerBidAdapter","module","exports"],"mappings":"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","file":"carambolaBidAdapter.js","sourcesContent":["/**\n * Carambola adapter\n */\n\nconst bidfactory = require('src/bidfactory.js');\nconst bidmanager = require('src/bidmanager.js');\nconst utils = require('src/utils.js');\nconst ajax = require('src/ajax.js').ajax;\nconst adaptermanager = require('src/adaptermanager');\n\nfunction CarambolaAdapter() {\n  const BIDDER_CODE = 'carambola';\n  const REQUEST_PATH = 'hb/inimage/getHbBIdProcessedResponse';\n\n  function _addErrorBidResponse(bid, response = {}, errorMsg = '') {\n    const bidResponse = bidfactory.createBid(2, bid);\n    bidResponse.bidderCode = BIDDER_CODE;\n    bidResponse.reason = errorMsg;\n    bidmanager.addBidResponse(_getCustomAdUnitCode(bid), bidResponse);\n  }\n  //  looking at the utils.js at getBidderRequest method. this is what is requested.\n  function _getCustomAdUnitCode(bid) {\n    return bid.placementCode;\n  }\n\n  function _addBidResponse(bid, response) {\n    const bidResponse = bidfactory.createBid(1, bid);\n    bidResponse.bidderCode = BIDDER_CODE;\n    bidResponse.ad = response.ad;\n    bidResponse.cpm = response.cpm;\n    bidResponse.width = response.width;\n    bidResponse.height = response.height;\n    bidResponse.currencyCode = response.cur;\n    bidResponse.token = response.token;\n    bidResponse.pvid = response.pageViewId;\n\n    bidmanager.addBidResponse(_getCustomAdUnitCode(bid), bidResponse);\n  }\n\n  function _getPageViewId() {\n    window.Cbola = window.Cbola || {};\n    window.Cbola.HB = window.Cbola.HB || {};\n    window.Cbola.HB.pvid = window.Cbola.HB.pvid || _createPageViewId();\n    return window.Cbola.HB.pvid;\n  }\n\n  function _createPageViewId() {\n    function _pad(number) {\n      return number > 9 ? number : '0' + number\n    }\n\n    const MIN = 10000;\n    const MAX = 90000;\n    let now = new Date();\n\n    var pvid =\n      _pad(now.getDate()) +\n      _pad(now.getMonth() + 1) +\n      _pad(now.getFullYear() % 100) +\n      _pad(now.getHours()) +\n      _pad(now.getMinutes()) +\n      _pad(now.getSeconds()) +\n      _pad(now.getMilliseconds() % 100) +\n      Math.floor((Math.random() * MAX) + MIN);\n\n    return pvid;\n  }\n\n  //  sends a request for each bid\n  function _buildRequest(bids, params) {\n    if (!utils.isArray(bids)) {\n      return;\n    }\n    //  iterate on every bid and return the  response to the hb manager\n    utils._each(bids, bid => {\n      let tempParams = params || {};\n      tempParams.cbolaMode = bid.params.cbolaMode || 0;\n      tempParams.wid = bid.params.wid || 0;\n      tempParams.pixel = bid.params.pixel || '';\n      tempParams.bidFloor = bid.params.bidFloor || 0;\n      tempParams.pageViewId = _getPageViewId();\n      tempParams.hb_token = utils.generateUUID();\n      tempParams.sizes = utils.parseSizesInput(bid.sizes) + '';\n      tempParams.bidsCount = bids.length;\n\n      for (let customParam in bid.params.customParams) {\n        if (bid.params.customParams.hasOwnProperty(customParam)) {\n          tempParams['c_' + customParam] = bid.params.customParams[customParam];\n        }\n      }\n\n      let server = bid.params.server || 'hb.carambo.la';\n      let cbolaHbApiUrl = '//' + server + '/' + REQUEST_PATH;\n\n      //  the responses of the bid requests\n      ajax(cbolaHbApiUrl + _jsonToQueryString(tempParams), response => {\n        //  no response\n        if (!response || response.cpm <= 0) {\n          utils.logError('Empty bid response', BIDDER_CODE, bid);\n          _addErrorBidResponse(bid, response, 'Empty bid response');\n          return;\n        }\n        try {\n          response = JSON.parse(response);\n          if (response && response.cpm <= 0) {\n            utils.logError('Bid response returned 0', BIDDER_CODE, bid);\n            _addErrorBidResponse(bid, response, 'Bid response returned 0');\n            return;\n          }\n        } catch (e) {\n          utils.logError('Invalid JSON in bid response', BIDDER_CODE, bid);\n          _addErrorBidResponse(bid, response, 'Invalid JSON in bid response');\n          return;\n        }\n        _addBidResponse(bid, response);\n      }, null, {method: 'GET'});\n    });\n  }\n\n  //  build the genral request to the server\n  function _callBids(params) {\n    let isIfr;\n    const bids = params.bids || [];\n    let currentURL = (window.parent !== window) ? document.referrer : window.location.href;\n    currentURL = currentURL && encodeURIComponent(currentURL);\n    try {\n      isIfr = window.self !== window.top;\n    } catch (e) {\n      isIfr = false;\n    }\n    if (bids.length === 0) {\n      return;\n    }\n\n    _buildRequest(bids, {\n      pageUrl: currentURL,\n      did: bids[0].params.did || 0,\n      pid: bids[0].params.pid || '',\n      res: _getScreenSize(screen),\n      ifr: isIfr,\n      viewPortDim: _getViewportDimensions(isIfr)\n    });\n  }\n\n  function _getScreenSize(screen) {\n    return screen ? `${screen.width}x${screen.height}x${screen.colorDepth}` : '0';\n  }\n\n  function _getViewportDimensions(isIfr) {\n    let width;\n    let height;\n    let tWin = window;\n    let tDoc = document;\n    let docEl = tDoc.documentElement;\n    let body;\n\n    if (isIfr) {\n      try {\n        tWin = window.top;\n        tDoc = window.top.document;\n      } catch (e) {\n        return;\n      }\n      docEl = tDoc.documentElement;\n      body = tDoc.body;\n      width = tWin.innerWidth || docEl.clientWidth || body.clientWidth;\n      height = tWin.innerHeight || docEl.clientHeight || body.clientHeight;\n    } else {\n      docEl = tDoc.documentElement;\n      width = tWin.innerWidth || docEl.clientWidth;\n      height = tWin.innerHeight || docEl.clientHeight;\n    }\n    return `${width}x${height}`;\n  }\n\n  function _jsonToQueryString(json) {\n    return '?' +\n      Object.keys(json).map(function(key) {\n        return encodeURIComponent(key) + '=' +\n          encodeURIComponent(json[key]);\n      }).join('&');\n  }\n\n  // Export the `callBids` function, so that Prebid.js can  execute\n  // this function when the page asks to send out bid requests.\n  return {\n    callBids: _callBids\n  };\n}\n\nadaptermanager.registerBidAdapter(new CarambolaAdapter(), 'carambola');\n\nmodule.exports = CarambolaAdapter;\n\n\n\n// WEBPACK FOOTER //\n// ./modules/carambolaBidAdapter.js"],"sourceRoot":""}