{"version":3,"sources":["webpack:///./modules/pubgearsBidAdapter.js"],"names":["bidfactory","require","bidmanager","consts","utils","adaptermanager","d","document","SCRIPT","PARAMS","SIZES","SIZE","CPM","AD","WIDTH","HEIGHT","PUB_ZONE","GROSS_PRICE","RESOURCE","DETAIL","BIDDER_CODE_RESPONSE_KEY","BIDDER_CODE","SCRIPT_ID","ATTRIBUTE_PREFIX","SLOT_LIST_ATTRIBUTE","PUBLISHER_ATTRIBUTE","FLAG_ATTRIBUTE","PLACEMENT_CODE","BID_ID","PUBLISHER_PARAM","PUB_ZONE_PARAM","BID_RECEIVED_EVENT_NAME","SLOT_READY_EVENT_NAME","CREATIVE_TEMPLATE","decodeURIComponent","TAG_URL","publisher","registerBidAdapter","PubGearsAdapter","module","exports","proxy","pendingSlots","initialized","callBids","params","bids","JSON_MAPPING","PL_BIDS","slots","map","getSlotFromBidParam","length","forEach","bid","name","getScript","makeScript","registerEventListeners","loadScript","script","anchor","scripts","getElementsByTagName","parentNode","insertBefore","size","getSize","slotName","join","getSlotFromResource","resource","key","sizes","Array","isArray","id","url","createElement","src","setAttribute","getElementById","addEventListener","onBid","onComplete","event","data","slotKey","bidRequest","adUnitCode","buildResponse","addBidResponse","logMessage","logError","eventData","dims","split","price","Number","status","isNaN","response","createBid","getCreative","token","creative","replacementValues","publisher_name","pub_zone","replaceTokenInString"],"mappings":"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","file":"pubgearsBidAdapter.js","sourcesContent":["var bidfactory = require('src/bidfactory.js');\nvar bidmanager = require('src/bidmanager.js');\nvar consts = require('src/constants.json');\nvar utils = require('src/utils.js');\nvar adaptermanager = require('src/adaptermanager');\nvar d = document;\nvar SCRIPT = 'script';\nvar PARAMS = 'params';\nvar SIZES = 'sizes';\nvar SIZE = 'size';\nvar CPM = 'cpm';\nvar AD = 'ad';\nvar WIDTH = 'width';\nvar HEIGHT = 'height';\nvar PUB_ZONE = 'pub_zone';\nvar GROSS_PRICE = 'gross_price';\nvar RESOURCE = 'resource';\nvar DETAIL = 'detail';\nvar BIDDER_CODE_RESPONSE_KEY = 'bidderCode';\nvar BIDDER_CODE = 'pubgears';\nvar SCRIPT_ID = 'pg-header-tag';\nvar ATTRIBUTE_PREFIX = 'data-bsm-';\nvar SLOT_LIST_ATTRIBUTE = 'slot-list';\nvar PUBLISHER_ATTRIBUTE = 'pub';\nvar FLAG_ATTRIBUTE = 'flag';\nvar PLACEMENT_CODE = 'placementCode';\nvar BID_ID = 'bidId';\nvar PUBLISHER_PARAM = 'publisherName';\nvar PUB_ZONE_PARAM = 'pubZone';\nvar BID_RECEIVED_EVENT_NAME = 'onBidResponse';\nvar SLOT_READY_EVENT_NAME = 'onResourceComplete';\nvar CREATIVE_TEMPLATE = decodeURIComponent(\"%3Cscript%3E%0A(function(define)%7B%0Adefine(function(a)%7B%0A%09var%20id%3D%20%22pg-ad-%22%20%2B%20Math.floor(Math.random()%20*%201e10)%2C%20d%3D%20document%0A%09d.write(\\'%3Cdiv%20id%3D%22\\'%2Bid%2B\\'%22%3E%3C%2Fdiv%3E\\')%0A%09a.push(%7B%0A%09%09pub%3A%20\\'%25%25PUBLISHER_NAME%25%25\\'%2C%0A%09%09pub_zone%3A%20\\'%25%25PUB_ZONE%25%25\\'%2C%0A%09%09sizes%3A%20%5B\\'%25%25SIZE%25%25\\'%5D%2C%0A%09%09flag%3A%20true%2C%0A%09%09container%3A%20d.getElementById(id)%2C%0A%09%7D)%3B%0A%7D)%7D)(function(f)%7Bvar%20key%3D\\'uber_imps\\'%2Ca%3Dthis%5Bkey%5D%3Dthis%5Bkey%5D%7C%7C%5B%5D%3Bf(a)%3B%7D)%3B%0A%3C%2Fscript%3E%0A%3Cscript%20src%3D%22%2F%2Fc.pubgears.com%2Ftags%2Fb%22%3E%3C%2Fscript%3E%0A\");\nvar TAG_URL = '//c.pubgears.com/tags/h';\nvar publisher = '';\n\nadaptermanager.registerBidAdapter(new PubGearsAdapter(), BIDDER_CODE);\n\nmodule.exports = PubGearsAdapter;\n\nfunction PubGearsAdapter() {\n  var proxy = null;\n  var pendingSlots = {};\n  var initialized = false;\n\n  this.callBids = callBids;\n\n  function callBids(params) {\n    var bids = params[consts.JSON_MAPPING.PL_BIDS];\n    var slots = bids.map(getSlotFromBidParam);\n    if (slots.length <= 0) { return; }\n    publisher = bids[0][PARAMS][PUBLISHER_PARAM];\n\n    bids.forEach(function(bid) {\n      var name = getSlotFromBidParam(bid);\n      pendingSlots[ name ] = bid;\n    });\n\n    proxy = proxy || getScript(SCRIPT_ID) || makeScript(slots, publisher, SCRIPT_ID, TAG_URL);\n    if (!initialized) { registerEventListeners(proxy); }\n    initialized = true;\n  }\n  function loadScript(script) {\n    var anchor = (function(scripts) {\n      return scripts[ scripts.length - 1 ];\n    })(d.getElementsByTagName(SCRIPT));\n\n    return anchor.parentNode.insertBefore(script, anchor);\n  }\n  function getSlotFromBidParam(bid) {\n    var size = getSize(bid);\n    var params = bid[PARAMS];\n    var slotName = params[PUB_ZONE_PARAM];\n    return [ slotName, size ].join('@');\n  }\n  function getSlotFromResource(resource) {\n    var size = resource[SIZE];\n    var key = [ resource[PUB_ZONE], size ].join('@');\n    return key;\n  }\n  function getSize(bid) {\n    var sizes = bid[SIZES];\n    var size = Array.isArray(sizes[0]) ? sizes[0] : sizes;\n    return size.join('x');\n  }\n  function makeScript(slots, publisher, id, url) {\n    var script = d.createElement(SCRIPT);\n    script.src = url;\n    script.id = id;\n    script.setAttribute(ATTRIBUTE_PREFIX + SLOT_LIST_ATTRIBUTE, slots.join(' '));\n    script.setAttribute(ATTRIBUTE_PREFIX + FLAG_ATTRIBUTE, 'true');\n    script.setAttribute(ATTRIBUTE_PREFIX + PUBLISHER_ATTRIBUTE, publisher);\n\n    return loadScript(script);\n  }\n  function getScript(id) {\n    return d.getElementById(id);\n  }\n  function registerEventListeners(script) {\n    script.addEventListener(BID_RECEIVED_EVENT_NAME, onBid, true);\n    script.addEventListener(SLOT_READY_EVENT_NAME, onComplete, true);\n  }\n  function onBid(event) {\n    var data = event[DETAIL];\n    var slotKey = getSlotFromResource(data[RESOURCE]);\n    var bidRequest = pendingSlots[slotKey];\n    var adUnitCode = bidRequest[PLACEMENT_CODE];\n    var bid = null;\n\n    if (bidRequest) {\n      bid = buildResponse(data, bidRequest);\n      bidmanager.addBidResponse(adUnitCode, bid);\n      utils.logMessage('adding bid respoonse to \"' + adUnitCode + '\" for bid request \"' + bidRequest[BID_ID] + '\"');\n    } else {\n      utils.logError('Cannot get placement id for slot \"' + slotKey + '\"');\n    }\n  }\n  function buildResponse(eventData, bidRequest) {\n    var resource = eventData[RESOURCE];\n    var dims = resource[SIZE].split('x');\n    var price = Number(eventData[GROSS_PRICE]);\n    var status = isNaN(price) || price <= 0 ? 2 : 1;\n\n    var response = bidfactory.createBid(status, bidRequest);\n    response[BIDDER_CODE_RESPONSE_KEY] = BIDDER_CODE;\n\n    if (status !== 1) { return response; }\n\n    response[AD] = getCreative(resource);\n\n    response[CPM] = price / 1e3;\n    response[WIDTH] = dims[0];\n    response[HEIGHT] = dims[1];\n    return response;\n  }\n  function getCreative(resource) {\n    var token = '%%';\n    var creative = CREATIVE_TEMPLATE;\n    var replacementValues = {\n      publisher_name: publisher,\n      pub_zone: resource[PUB_ZONE],\n      size: resource[SIZE]\n    };\n    return utils.replaceTokenInString(creative, replacementValues, token);\n  }\n  function onComplete(event) {\n    var data = event[DETAIL];\n    var slotKey = getSlotFromResource(data[RESOURCE]);\n    delete pendingSlots[slotKey];\n  }\n}\n\n\n\n// WEBPACK FOOTER //\n// ./modules/pubgearsBidAdapter.js"],"sourceRoot":""}