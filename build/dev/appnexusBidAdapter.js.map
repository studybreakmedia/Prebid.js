{"version":3,"sources":["webpack:///./modules/appnexusBidAdapter.js"],"names":["CONSTANTS","require","utils","adloader","bidmanager","bidfactory","Adapter","AppNexusAdapter","baseAdapter","usersync","callBids","params","anArr","bids","i","length","bidRequest","callbackId","bidId","loadScript","buildJPTCall","bid","placementId","getBidIdParameter","memberId","member","inventoryCode","query","referrer","altReferrer","usePaymentRule","jptCall","tryAppendQueryString","logMessage","sizeQueryString","parsedSizes","parseSizesInput","sizes","parsedSizesLength","j","charAt","slice","targetingParams","parseQueryStringParameters","paramsCopy","invCode","alt_referrer","queryParams","getTopWindowUrl","lastIndexOf","substring","startTime","Date","getTime","pbjs","handleAnCB","jptResponseObj","bidCode","callback_uid","responseCPM","id","placementCode","bidObj","bidder","status","STATUS","GOOD","result","cpm","parseInt","adId","creative_id","createBid","bidderCode","adUrl","ad","width","height","dealId","deal_id","addBidResponse","iframe","createInvisibleIframe","src","document","body","appendChild","error","logError","setBidderCode","registerBidAdapter","aliasBidAdapter","module","exports"],"mappings":";;;;;;;;;;;;;;;;;;AAAA;;AACA;;;;;;AAEA,IAAIA,YAAY,mBAAAC,CAAQ,CAAR,CAAhB;AACA,IAAIC,QAAQ,mBAAAD,CAAQ,CAAR,CAAZ;AACA,IAAIE,WAAW,mBAAAF,CAAQ,CAAR,CAAf;AACA,IAAIG,aAAa,mBAAAH,CAAQ,CAAR,CAAjB;AACA,IAAII,aAAa,mBAAAJ,CAAQ,CAAR,CAAjB;AACA,IAAIK,UAAU,mBAAAL,CAAQ,CAAR,YAAd;;AAEA,IAAIM,eAAJ;AACAA,kBAAkB,SAASA,eAAT,GAA2B;AAC3C,MAAIC,cAAc,IAAIF,OAAJ,CAAY,UAAZ,CAAlB;AACA,MAAIG,WAAW,KAAf;;AAEAD,cAAYE,QAAZ,GAAuB,UAAUC,MAAV,EAAkB;AACvC;;AAEA,QAAIC,QAAQD,OAAOE,IAAnB;;AAEA;;AAEA;AACA;;AAEA,SAAK,IAAIC,IAAI,CAAb,EAAgBA,IAAIF,MAAMG,MAA1B,EAAkCD,GAAlC,EAAuC;AACrC,UAAIE,aAAaJ,MAAME,CAAN,CAAjB;AACA,UAAIG,aAAaD,WAAWE,KAA5B;AACAf,eAASgB,UAAT,CAAoBC,aAAaJ,UAAb,EAAyBC,UAAzB,CAApB;;AAEA;AACA;AACD;AACF,GAlBD;;AAoBA,WAASG,YAAT,CAAsBC,GAAtB,EAA2BJ,UAA3B,EAAuC;AACrC;AACA,QAAIK,cAAcpB,MAAMqB,iBAAN,CAAwB,aAAxB,EAAuCF,IAAIV,MAA3C,CAAlB;;AAEA;AACA,QAAIa,WAAWtB,MAAMqB,iBAAN,CAAwB,UAAxB,EAAoCF,IAAIV,MAAxC,CAAf;AACA,QAAIc,SAASvB,MAAMqB,iBAAN,CAAwB,QAAxB,EAAkCF,IAAIV,MAAtC,CAAb;AACA,QAAIe,gBAAgBxB,MAAMqB,iBAAN,CAAwB,SAAxB,EAAmCF,IAAIV,MAAvC,CAApB;AACA,QAAIgB,QAAQzB,MAAMqB,iBAAN,CAAwB,OAAxB,EAAiCF,IAAIV,MAArC,CAAZ;AACA,QAAIiB,WAAW1B,MAAMqB,iBAAN,CAAwB,UAAxB,EAAoCF,IAAIV,MAAxC,CAAf;AACA,QAAIkB,cAAc3B,MAAMqB,iBAAN,CAAwB,cAAxB,EAAwCF,IAAIV,MAA5C,CAAlB;AACA,QAAImB,iBAAiB5B,MAAMqB,iBAAN,CAAwB,gBAAxB,EAA0CF,IAAIV,MAA9C,CAArB;AACA,QAAIoB,UAAU,qBAAd;;AAEAA,cAAU7B,MAAM8B,oBAAN,CAA2BD,OAA3B,EAAoC,UAApC,EAAgD,iBAAhD,CAAV;AACAA,cAAU7B,MAAM8B,oBAAN,CAA2BD,OAA3B,EAAoC,cAApC,EAAoDd,UAApD,CAAV;AACAc,cAAU7B,MAAM8B,oBAAN,CAA2BD,OAA3B,EAAoC,KAApC,EAA2C,GAA3C,CAAV;AACAA,cAAU7B,MAAM8B,oBAAN,CAA2BD,OAA3B,EAAoC,IAApC,EAA0CT,WAA1C,CAAV;AACAS,cAAU7B,MAAM8B,oBAAN,CAA2BD,OAA3B,EAAoC,cAApC,EAAoDD,cAApD,CAAV;;AAEA,QAAIL,MAAJ,EAAY;AACVM,gBAAU7B,MAAM8B,oBAAN,CAA2BD,OAA3B,EAAoC,QAApC,EAA8CN,MAA9C,CAAV;AACD,KAFD,MAEO,IAAID,QAAJ,EAAc;AACnBO,gBAAU7B,MAAM8B,oBAAN,CAA2BD,OAA3B,EAAoC,QAApC,EAA8CP,QAA9C,CAAV;AACAtB,YAAM+B,UAAN,CAAiB,oFAAjB;AACD;;AAEDF,cAAU7B,MAAM8B,oBAAN,CAA2BD,OAA3B,EAAoC,MAApC,EAA4CL,aAA5C,CAAV;AACAK,cAAU7B,MAAM8B,oBAAN,CAA2BD,OAA3B,EAAoC,qBAApC,EAA4D7B,MAAMqB,iBAAN,CAAwB,mBAAxB,EAA6CF,IAAIV,MAAjD,CAA5D,CAAV;;AAEA;AACA,QAAIuB,kBAAkB,EAAtB;AACA,QAAIC,cAAcjC,MAAMkC,eAAN,CAAsBf,IAAIgB,KAA1B,CAAlB;;AAEA;AACA,QAAIC,oBAAoBH,YAAYpB,MAApC;AACA,QAAIuB,oBAAoB,CAAxB,EAA2B;AACzB;AACAJ,wBAAkB,UAAUC,YAAY,CAAZ,CAA5B;AACA,UAAIG,oBAAoB,CAAxB,EAA2B;AACzB;AACAJ,2BAAmB,eAAnB;AACA,aAAK,IAAIK,IAAI,CAAb,EAAgBA,IAAID,iBAApB,EAAuCC,GAAvC,EAA4C;AAC1CL,6BAAmBC,YAAYI,CAAZ,KAAkB,GAArC;AACD;;AAED;AACA,YAAIL,mBAAmBA,gBAAgBM,MAAhB,CAAuBN,gBAAgBnB,MAAhB,GAAyB,CAAhD,MAAuD,GAA9E,EAAmF;AACjFmB,4BAAkBA,gBAAgBO,KAAhB,CAAsB,CAAtB,EAAyBP,gBAAgBnB,MAAhB,GAAyB,CAAlD,CAAlB;AACD;AACF;AACF;;AAED,QAAImB,eAAJ,EAAqB;AACnBH,iBAAWG,kBAAkB,GAA7B;AACD;;AAED;AACA,QAAIQ,kBAAkBxC,MAAMyC,0BAAN,CAAiChB,KAAjC,CAAtB;;AAEA,QAAIe,eAAJ,EAAqB;AACnB;AACAX,iBAAWW,eAAX;AACD;;AAED;AACA,QAAIE,aAAa,SAAc,EAAd,EAAkBvB,IAAIV,MAAtB,CAAjB;;AAEA;AACA,WAAOiC,WAAWtB,WAAlB;AACA,WAAOsB,WAAWpB,QAAlB;AACA,WAAOoB,WAAWC,OAAlB;AACA,WAAOD,WAAWjB,KAAlB;AACA,WAAOiB,WAAWhB,QAAlB;AACA,WAAOgB,WAAWE,YAAlB;AACA,WAAOF,WAAWnB,MAAlB;AACA,WAAOmB,WAAWd,cAAlB;;AAEA;AACA,QAAIiB,cAAc7C,MAAMyC,0BAAN,CAAiCC,UAAjC,CAAlB;;AAEA;AACA,QAAIG,WAAJ,EAAiB;AACfhB,iBAAWgB,WAAX;AACD;;AAED;AACA,QAAInB,aAAa,EAAjB,EAAqB;AACnBA,iBAAW1B,MAAM8C,eAAN,EAAX;AACD;;AAEDjB,cAAU7B,MAAM8B,oBAAN,CAA2BD,OAA3B,EAAoC,UAApC,EAAgDH,QAAhD,CAAV;AACAG,cAAU7B,MAAM8B,oBAAN,CAA2BD,OAA3B,EAAoC,cAApC,EAAoDF,WAApD,CAAV;;AAEA;AACA,QAAIE,QAAQkB,WAAR,CAAoB,GAApB,MAA6BlB,QAAQhB,MAAR,GAAiB,CAAlD,EAAqD;AACnDgB,gBAAUA,QAAQmB,SAAR,CAAkB,CAAlB,EAAqBnB,QAAQhB,MAAR,GAAiB,CAAtC,CAAV;AACD;;AAED;AACAb,UAAM+B,UAAN,CAAiB,wBAAwBF,OAAzC;;AAEA;;AAEA;AACAV,QAAI8B,SAAJ,GAAgB,IAAIC,IAAJ,GAAWC,OAAX,EAAhB;;AAEA,WAAOtB,OAAP;AACD;;AAED;AACAuB,OAAKC,UAAL,GAAkB,UAAUC,cAAV,EAA0B;AAC1C,QAAIC,OAAJ;;AAEA,QAAID,kBAAkBA,eAAeE,YAArC,EAAmD;AACjD,UAAIC,WAAJ;AACA,UAAIC,KAAKJ,eAAeE,YAAxB;AACA,UAAIG,gBAAgB,EAApB;AACA,UAAIC,SAAS,0BAAcF,EAAd,CAAb;AACA,UAAIE,MAAJ,EAAY;AACVL,kBAAUK,OAAOC,MAAjB;;AAEAF,wBAAgBC,OAAOD,aAAvB;;AAEA;AACAC,eAAOE,MAAP,GAAgBhE,UAAUiE,MAAV,CAAiBC,IAAjC;AACD;;AAED;AACAhE,YAAM+B,UAAN,CAAiB,+CAA+C2B,EAAhE;;AAEA;AACA,UAAIvC,MAAM,EAAV;AACA,UAAImC,eAAeW,MAAf,IAAyBX,eAAeW,MAAf,CAAsBC,GAA/C,IAAsDZ,eAAeW,MAAf,CAAsBC,GAAtB,KAA8B,CAAxF,EAA2F;AACzFT,sBAAcU,SAASb,eAAeW,MAAf,CAAsBC,GAA/B,EAAoC,EAApC,CAAd;;AAEA;AACA;AACA;AACAT,sBAAcA,cAAc,KAA5B;;AAEA;AACA;AACA,YAAIW,OAAOd,eAAeW,MAAf,CAAsBI,WAAjC;AACAlD,cAAMhB,WAAWmE,SAAX,CAAqB,CAArB,EAAwBV,MAAxB,CAAN;AACAzC,YAAIkD,WAAJ,GAAkBD,IAAlB;AACAjD,YAAIoD,UAAJ,GAAiBhB,OAAjB;AACApC,YAAI+C,GAAJ,GAAUT,WAAV;AACAtC,YAAIqD,KAAJ,GAAYlB,eAAeW,MAAf,CAAsBQ,EAAlC;AACAtD,YAAIuD,KAAJ,GAAYpB,eAAeW,MAAf,CAAsBS,KAAlC;AACAvD,YAAIwD,MAAJ,GAAarB,eAAeW,MAAf,CAAsBU,MAAnC;AACAxD,YAAIyD,MAAJ,GAAatB,eAAeW,MAAf,CAAsBY,OAAnC;;AAEA3E,mBAAW4E,cAAX,CAA0BnB,aAA1B,EAAyCxC,GAAzC;AACD,OArBD,MAqBO;AACL;AACA;AACAnB,cAAM+B,UAAN,CAAiB,yDAAyD4B,aAA1E;;AAEA;AACA;AACAxC,cAAMhB,WAAWmE,SAAX,CAAqB,CAArB,EAAwBV,MAAxB,CAAN;AACAzC,YAAIoD,UAAJ,GAAiBhB,OAAjB;AACArD,mBAAW4E,cAAX,CAA0BnB,aAA1B,EAAyCxC,GAAzC;AACD;;AAED,UAAI,CAACZ,QAAL,EAAe;AACb,YAAIwE,SAAS/E,MAAMgF,qBAAN,EAAb;AACAD,eAAOE,GAAP,GAAa,4DAAb;AACA,YAAI;AACFC,mBAASC,IAAT,CAAcC,WAAd,CAA0BL,MAA1B;AACD,SAFD,CAEE,OAAOM,KAAP,EAAc;AACdrF,gBAAMsF,QAAN,CAAeD,KAAf;AACD;AACD9E,mBAAW,IAAX;AACD;AACF,KA9DD,MA8DO;AACL;AACA;AACAP,YAAM+B,UAAN,CAAiB,gDAAjB;;AAEA;AACD;AACF,GAxED;;AA0EA,SAAO,SAAc,IAAd,EAAoB;AACzBvB,cAAUF,YAAYE,QADG;AAEzB+E,mBAAejF,YAAYiF,aAFF;AAGzBrE,kBAAcA;AAHW,GAApB,CAAP;AAKD,CAtND;;AAwNA,4BAAesE,kBAAf,CAAkC,IAAInF,eAAJ,EAAlC,EAAyD,UAAzD;AACA,4BAAeoF,eAAf,CAA+B,UAA/B,EAA2C,WAA3C;AACA,4BAAeA,eAAf,CAA+B,UAA/B,EAA2C,aAA3C;AACA,4BAAeA,eAAf,CAA+B,UAA/B,EAA2C,WAA3C;AACA,4BAAeA,eAAf,CAA+B,UAA/B,EAA2C,YAA3C;AACA,4BAAeA,eAAf,CAA+B,UAA/B,EAA2C,QAA3C;AACA,4BAAeA,eAAf,CAA+B,UAA/B,EAA2C,gBAA3C;AACA,4BAAeA,eAAf,CAA+B,UAA/B,EAA2C,UAA3C;;AAEAC,OAAOC,OAAP,GAAiBtF,eAAjB,C","file":"appnexusBidAdapter.js","sourcesContent":["import { getBidRequest } from 'src/utils';\nimport adaptermanager from 'src/adaptermanager';\n\nvar CONSTANTS = require('src/constants');\nvar utils = require('src/utils');\nvar adloader = require('src/adloader');\nvar bidmanager = require('src/bidmanager');\nvar bidfactory = require('src/bidfactory');\nvar Adapter = require('src/adapter').default;\n\nvar AppNexusAdapter;\nAppNexusAdapter = function AppNexusAdapter() {\n  var baseAdapter = new Adapter('appnexus');\n  var usersync = false;\n\n  baseAdapter.callBids = function (params) {\n    // var bidCode = baseAdapter.getBidderCode();\n\n    var anArr = params.bids;\n\n    // var bidsCount = anArr.length;\n\n    // set expected bids count for callback execution\n    // bidmanager.setExpectedBidsCount(bidCode, bidsCount);\n\n    for (var i = 0; i < anArr.length; i++) {\n      var bidRequest = anArr[i];\n      var callbackId = bidRequest.bidId;\n      adloader.loadScript(buildJPTCall(bidRequest, callbackId));\n\n      // store a reference to the bidRequest from the callback id\n      // bidmanager.pbCallbackMap[callbackId] = bidRequest;\n    }\n  };\n\n  function buildJPTCall(bid, callbackId) {\n    // determine tag params\n    var placementId = utils.getBidIdParameter('placementId', bid.params);\n\n    // memberId will be deprecated, use member instead\n    var memberId = utils.getBidIdParameter('memberId', bid.params);\n    var member = utils.getBidIdParameter('member', bid.params);\n    var inventoryCode = utils.getBidIdParameter('invCode', bid.params);\n    var query = utils.getBidIdParameter('query', bid.params);\n    var referrer = utils.getBidIdParameter('referrer', bid.params);\n    var altReferrer = utils.getBidIdParameter('alt_referrer', bid.params);\n    let usePaymentRule = utils.getBidIdParameter('usePaymentRule', bid.params);\n    var jptCall = '//ib.adnxs.com/jpt?';\n\n    jptCall = utils.tryAppendQueryString(jptCall, 'callback', 'pbjs.handleAnCB');\n    jptCall = utils.tryAppendQueryString(jptCall, 'callback_uid', callbackId);\n    jptCall = utils.tryAppendQueryString(jptCall, 'psa', '0');\n    jptCall = utils.tryAppendQueryString(jptCall, 'id', placementId);\n    jptCall = utils.tryAppendQueryString(jptCall, 'use_pmt_rule', usePaymentRule);\n\n    if (member) {\n      jptCall = utils.tryAppendQueryString(jptCall, 'member', member);\n    } else if (memberId) {\n      jptCall = utils.tryAppendQueryString(jptCall, 'member', memberId);\n      utils.logMessage('appnexus.callBids: \"memberId\" will be deprecated soon. Please use \"member\" instead');\n    }\n\n    jptCall = utils.tryAppendQueryString(jptCall, 'code', inventoryCode);\n    jptCall = utils.tryAppendQueryString(jptCall, 'traffic_source_code', (utils.getBidIdParameter('trafficSourceCode', bid.params)));\n\n    // sizes takes a bit more logic\n    var sizeQueryString = '';\n    var parsedSizes = utils.parseSizesInput(bid.sizes);\n\n    // combine string into proper querystring for impbus\n    var parsedSizesLength = parsedSizes.length;\n    if (parsedSizesLength > 0) {\n      // first value should be \"size\"\n      sizeQueryString = 'size=' + parsedSizes[0];\n      if (parsedSizesLength > 1) {\n        // any subsequent values should be \"promo_sizes\"\n        sizeQueryString += '&promo_sizes=';\n        for (var j = 1; j < parsedSizesLength; j++) {\n          sizeQueryString += parsedSizes[j] += ',';\n        }\n\n        // remove trailing comma\n        if (sizeQueryString && sizeQueryString.charAt(sizeQueryString.length - 1) === ',') {\n          sizeQueryString = sizeQueryString.slice(0, sizeQueryString.length - 1);\n        }\n      }\n    }\n\n    if (sizeQueryString) {\n      jptCall += sizeQueryString + '&';\n    }\n\n    // this will be deprecated soon\n    var targetingParams = utils.parseQueryStringParameters(query);\n\n    if (targetingParams) {\n      // don't append a & here, we have already done it in parseQueryStringParameters\n      jptCall += targetingParams;\n    }\n\n    // append custom attributes:\n    var paramsCopy = Object.assign({}, bid.params);\n\n    // delete attributes already used\n    delete paramsCopy.placementId;\n    delete paramsCopy.memberId;\n    delete paramsCopy.invCode;\n    delete paramsCopy.query;\n    delete paramsCopy.referrer;\n    delete paramsCopy.alt_referrer;\n    delete paramsCopy.member;\n    delete paramsCopy.usePaymentRule;\n\n    // get the reminder\n    var queryParams = utils.parseQueryStringParameters(paramsCopy);\n\n    // append\n    if (queryParams) {\n      jptCall += queryParams;\n    }\n\n    // append referrer\n    if (referrer === '') {\n      referrer = utils.getTopWindowUrl();\n    }\n\n    jptCall = utils.tryAppendQueryString(jptCall, 'referrer', referrer);\n    jptCall = utils.tryAppendQueryString(jptCall, 'alt_referrer', altReferrer);\n\n    // remove the trailing \"&\"\n    if (jptCall.lastIndexOf('&') === jptCall.length - 1) {\n      jptCall = jptCall.substring(0, jptCall.length - 1);\n    }\n\n    // @if NODE_ENV='debug'\n    utils.logMessage('jpt request built: ' + jptCall);\n\n    // @endif\n\n    // append a timer here to track latency\n    bid.startTime = new Date().getTime();\n\n    return jptCall;\n  }\n\n  // expose the callback to the global object:\n  pbjs.handleAnCB = function (jptResponseObj) {\n    var bidCode;\n\n    if (jptResponseObj && jptResponseObj.callback_uid) {\n      var responseCPM;\n      var id = jptResponseObj.callback_uid;\n      var placementCode = '';\n      var bidObj = getBidRequest(id);\n      if (bidObj) {\n        bidCode = bidObj.bidder;\n\n        placementCode = bidObj.placementCode;\n\n        // set the status\n        bidObj.status = CONSTANTS.STATUS.GOOD;\n      }\n\n      // @if NODE_ENV='debug'\n      utils.logMessage('JSONP callback function called for ad ID: ' + id);\n\n      // @endif\n      var bid = [];\n      if (jptResponseObj.result && jptResponseObj.result.cpm && jptResponseObj.result.cpm !== 0) {\n        responseCPM = parseInt(jptResponseObj.result.cpm, 10);\n\n        // CPM response from /jpt is dollar/cent multiplied by 10000\n        // in order to avoid using floats\n        // switch CPM to \"dollar/cent\"\n        responseCPM = responseCPM / 10000;\n\n        // store bid response\n        // bid status is good (indicating 1)\n        var adId = jptResponseObj.result.creative_id;\n        bid = bidfactory.createBid(1, bidObj);\n        bid.creative_id = adId;\n        bid.bidderCode = bidCode;\n        bid.cpm = responseCPM;\n        bid.adUrl = jptResponseObj.result.ad;\n        bid.width = jptResponseObj.result.width;\n        bid.height = jptResponseObj.result.height;\n        bid.dealId = jptResponseObj.result.deal_id;\n\n        bidmanager.addBidResponse(placementCode, bid);\n      } else {\n        // no response data\n        // @if NODE_ENV='debug'\n        utils.logMessage('No prebid response from AppNexus for placement code ' + placementCode);\n\n        // @endif\n        // indicate that there is no bid for this placement\n        bid = bidfactory.createBid(2, bidObj);\n        bid.bidderCode = bidCode;\n        bidmanager.addBidResponse(placementCode, bid);\n      }\n\n      if (!usersync) {\n        var iframe = utils.createInvisibleIframe();\n        iframe.src = '//acdn.adnxs.com/ib/static/usersync/v3/async_usersync.html';\n        try {\n          document.body.appendChild(iframe);\n        } catch (error) {\n          utils.logError(error);\n        }\n        usersync = true;\n      }\n    } else {\n      // no response data\n      // @if NODE_ENV='debug'\n      utils.logMessage('No prebid response for placement %%PLACEMENT%%');\n\n      // @endif\n    }\n  };\n\n  return Object.assign(this, {\n    callBids: baseAdapter.callBids,\n    setBidderCode: baseAdapter.setBidderCode,\n    buildJPTCall: buildJPTCall\n  });\n};\n\nadaptermanager.registerBidAdapter(new AppNexusAdapter(), 'appnexus');\nadaptermanager.aliasBidAdapter('appnexus', 'brealtime');\nadaptermanager.aliasBidAdapter('appnexus', 'pagescience');\nadaptermanager.aliasBidAdapter('appnexus', 'defymedia');\nadaptermanager.aliasBidAdapter('appnexus', 'gourmetads');\nadaptermanager.aliasBidAdapter('appnexus', 'matomy');\nadaptermanager.aliasBidAdapter('appnexus', 'featureforward');\nadaptermanager.aliasBidAdapter('appnexus', 'oftmedia');\n\nmodule.exports = AppNexusAdapter;\n\n\n\n// WEBPACK FOOTER //\n// ./modules/appnexusBidAdapter.js"],"sourceRoot":""}